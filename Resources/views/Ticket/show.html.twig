{% extends 'HackzillaTicketBundle::layout.html.twig' %}

{% block hackzilla_ticket_content -%}
<h1>Ticket #{{ ticket.id }}</h1>

<div class="row well">
    <div class="col-lg-6 col-md-6 col-sm-6">
        <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-6">Created:</div>
            <div class="col-lg-6 col-md-6 col-sm-6">{{ ticket.createdAt|date('Y-m-d H:i:s') }}</div>
        </div>
    </div>
    <div class="col-lg-6 col-md-6 col-sm-6">
        <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-6">Created By:</div>
            <div class="col-lg-6 col-md-6 col-sm-6">{% if ticket.userCreatedObject|isTicketAdmin('ROLE_TICKET_ADMIN') %}<span class="label label-default">Admin</span> {% endif %}{{ ticket.userCreatedObject }}</div>
        </div>
    </div>
    <div class="col-lg-6 col-md-6 col-sm-6">
        <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-6">Last Message By:</div>
            <div class="col-lg-6 col-md-6 col-sm-6">{% if ticket.lastUserObject|isTicketAdmin('ROLE_TICKET_ADMIN') %}<span class="label label-default">Admin</span> {% endif %}{{ ticket.lastUserObject }}</div>
        </div>
    </div>
    <div class="col-lg-6 col-md-6 col-sm-6">
        <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-6">Status:</div>
            <div class="col-lg-6 col-md-6 col-sm-6">{{ ticket.statusString }}</div>
        </div>
    </div>
    <div class="col-lg-6 col-md-6 col-sm-6">
        <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-6">Last Modified:</div>
            <div class="col-lg-6 col-md-6 col-sm-6">{{ ticket.lastMessage|date('Y-m-d H:i:s') }}</div>
        </div>
    </div>
    <div class="col-lg-6 col-md-6 col-sm-6">
        <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-6">Priority:</div>
            <div class="col-lg-6 col-md-6 col-sm-6">{{ ticket.priorityString }}</div>
        </div>
    </div>
</div>

{% set previousStatus = null %}
{% set previousPriority = null %}

<h3>Ticket Thread</h3>
<div class="ticket-messages">
{% for message in ticket.messages %}
<div class="ticket-message row well">
    <div class="col-lg-6 col-md-6 col-sm-6">
        <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-6">Author:</div>
            <div class="col-lg-6 col-md-6 col-sm-6">{% if message.userObject|isTicketAdmin('ROLE_TICKET_ADMIN') %}<span class="label label-default">Admin</span> {% endif %}{{ message.userObject }}</div>
        </div>
    </div>
    <div class="col-lg-6 col-md-6 col-sm-6">
        <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-6">Date:</div>
            <div class="col-lg-6 col-md-6 col-sm-6">{{ message.createdAt|date('Y-m-d H:i:s') }}</div>
        </div>
    </div>
    <div class="col-lg-6 col-md-6 col-sm-6">
        <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-6">Priority:</div>
            <div class="col-lg-6 col-md-6 col-sm-6">{{ message.priorityString }}</div>
        </div>
    </div>
    <div class="col-lg-6 col-md-6 col-sm-6">
        <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-6">Status:</div>
            <div class="col-lg-6 col-md-6 col-sm-6">{{ message.statusString }}</div>
        </div>
    </div>
    <div class="col-lg-12 col-md-12 col-sm-12">
        &nbsp;
    </div>
    <div class="col-lg-12 col-md-12 col-sm-12">
        Message:
        {% if message.message %}
            <br>{{ message.message|nl2br }}
        {% else %}
            -- Message was empty --
        {% endif %}
    </div>
    {% if not previousStatus or previousStatus != message.status or previousPriority != message.priority %}
    <div class="col-lg-12 col-md-12 col-sm-12">
        &nbsp;
    </div>
    {% endif %}
    <div class="col-lg-12 col-md-12 col-sm-12">
        {% if not previousStatus %}
            Ticket opened with priority: {{ message.priorityString }}
        {% else %}
            {% if(previousStatus != message.status) %}
                Status was changed to {{ message.statusString }}.
            {% endif %}
            {% if(previousPriority != message.priority) %}
                Priority was changed to {{ message.priorityString }}.
            {% endif %}
        {% endif %}
    </div>
</div>
    {% set previousStatus = message.status %}
    {% set previousPriority = message.priority %}
{% endfor %}
</div>

{% if form is defined %}
<form action="{{ path('hackzilla_ticket_reply', {id: ticket.id}) }}" method="post" {{ form_enctype(form) }}>

    {% include 'HackzillaTicketBundle:Ticket:prototype.html.twig' with {'form': form} %}

    {{ form_rest(form) }}
    
    <p class="form_actions">
        <button type="submit" class="btn btn-primary">Update</button>
    </p>
</form>
{% endif %}

<form action="{{ path('hackzilla_ticket_delete', { 'id': ticket.id }) }}" method="post">
    <input type="hidden" name="_method" value="DELETE" />
    {{ form_widget(delete_form) }}

    <a href="{{ path('hackzilla_ticket') }}" class="btn btn-default">
        Back to the list
    </a>

    <button type="submit" class="btn btn-danger">Delete</button>
</form>
{% endblock %}
